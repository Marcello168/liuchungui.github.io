<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>微信公众号开发总结 | 刘春桂的博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">微信公众号开发总结</h1><a id="logo" href="/.">刘春桂的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">微信公众号开发总结</h1><div class="post-meta">Aug 1, 2016<span> | </span><span class="category"><a href="/categories/web/">web</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" href="/2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/#comments" class="ds-thread-count"></a><div class="post-content"><p>公司准备在微信公众号上做个东西，所以研究了一周的微信公众号开发，今天在这里做一个总结。<br>在总结之前，先说一下本人使用的环境，语言是PHP，框架是<a href="https://github.com/bcit-ci/CodeIgniter" target="_blank" rel="external">CI</a>和CI框架下的一个RESTFul框架<a href="https://github.com/chriskacerguis/codeigniter-restserver" target="_blank" rel="external">codeigniter-restserver</a>。</p>
<a id="more"></a>
<h2 id="一、配置服务器"><a href="#一、配置服务器" class="headerlink" title="一、配置服务器"></a>一、配置服务器</h2><p>在开发之前，我们首先需要在微信公众号下设置服务器配置，这里完全可以参考官方的<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">接入指南</a>。<br>需要说明两点的是：</p>
<ol>
<li>我们只能填写一个URL（服务器地址），当微信服务器想要发送消息给我们服务器，只能通过这个URL来进行交互。</li>
<li>我们在接入的时候，有个验证消息是否来自微信服务器的过程，这个验证过程是GET请求，我们需要输出echostr，验证代码如下：</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 检查消息是否来自微信</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check_from_wx</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//检查$_GET中的参数</span></div><div class="line">    param_check($_GET, [<span class="string">'signature'</span>, <span class="string">'timestamp'</span>, <span class="string">'nonce'</span>]);</div><div class="line"></div><div class="line">    <span class="comment">//获取参数</span></div><div class="line">    $signature = $_GET[<span class="string">"signature"</span>];</div><div class="line">    $timestamp = $_GET[<span class="string">"timestamp"</span>];</div><div class="line">    $nonce = $_GET[<span class="string">"nonce"</span>];</div><div class="line"></div><div class="line">    $token = WX_APP_TOKEN;</div><div class="line">    $tmpArr = <span class="keyword">array</span>($token, $timestamp, $nonce);</div><div class="line">    <span class="comment">// use SORT_STRING rule</span></div><div class="line">    sort($tmpArr, SORT_STRING);</div><div class="line">    $tmpStr = implode($tmpArr);</div><div class="line">    $tmpStr = sha1($tmpStr);</div><div class="line">    </div><div class="line">    <span class="comment">//验证</span></div><div class="line">    <span class="keyword">if</span>($tmpStr == $signature) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 配合微信服务器验证是否有效</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_get</span><span class="params">()</span> </span>&#123;</div><div class="line">    $echoStr = <span class="keyword">$this</span>-&gt;get(<span class="string">"echostr"</span>);</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;check_from_wx()) &#123;</div><div class="line">       <span class="keyword">echo</span> $echoStr;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"验证不通过"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到上面的代码，你也许会有疑问，为什么在<code>check_get</code>方法中使用<code>$this-&gt;get</code>获取get参数，而在<code>check_from_wx</code>方法中使用的是<code>$_GET</code>。这是因为我们后面接收的消息是微信服务器向我们发送POST请求，但是验证的参数却是放在URL后面，所以为了兼容，专门封装了一个<code>check_from_wx</code>的私有方法。</p>
<p>到这里，我们算是配置好了，下面我们来看看如何接收和回复用户发来的消息。</p>
<h2 id="二、接收消息和回复消息"><a href="#二、接收消息和回复消息" class="headerlink" title="二、接收消息和回复消息"></a>二、接收消息和回复消息</h2><p>接收和回复消息的流程图大概就是这样的：<br><img src="http://ww4.sinaimg.cn/large/7746cd07jw1f66f138zo1j218q0imacd.jpg" alt=""><br>看上面的流程图，我们可以把整个接收和回复消息分成四个步骤：</p>
<ul>
<li>第一步：用户在微信公众号内发送一条消息，微信客户端将这条消息发送给微信服务器。</li>
<li>第二步：微信服务器将消息以POST方式将消息提交给我们服务器，而这个服务器的地址只有一个，就是我们前面配置服务器填写的URL地址。消息的数据格式是XML格式的。    </li>
<li>第三步：我们收到这个消息之后，做出对应的回复，返回对应的XML数据，就算是进行回复了。</li>
<li>第四步：微信服务器将我们服务器的消息返回给微信客户端，这样用户就看到了我们回复的消息了。</li>
</ul>
<p>看了上面的消息接收和回复流程图，我们下面使用代码进行实现。在配置服务器的时候，我先前填写的URL地址对应的接口是<code>check</code>，所以接收消息的PHP代码这么写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"><span class="comment">  * 检查消息是否来自微信</span></div><div class="line"><span class="comment">  * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment">  */</span></div><div class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check_from_wx</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="comment">//检查$_GET中的参数</span></div><div class="line">     param_check($_GET, [<span class="string">'signature'</span>, <span class="string">'timestamp'</span>, <span class="string">'nonce'</span>]);</div><div class="line"></div><div class="line">     <span class="comment">//获取参数</span></div><div class="line">     $signature = $_GET[<span class="string">"signature"</span>];</div><div class="line">     $timestamp = $_GET[<span class="string">"timestamp"</span>];</div><div class="line">     $nonce = $_GET[<span class="string">"nonce"</span>];</div><div class="line"></div><div class="line">     $token = WX_APP_TOKEN;</div><div class="line">     $tmpArr = <span class="keyword">array</span>($token, $timestamp, $nonce);</div><div class="line">     <span class="comment">// use SORT_STRING rule</span></div><div class="line">     sort($tmpArr, SORT_STRING);</div><div class="line">     $tmpStr = implode($tmpArr);</div><div class="line">     $tmpStr = sha1($tmpStr);</div><div class="line">     </div><div class="line">     <span class="comment">//验证</span></div><div class="line">     <span class="keyword">if</span>($tmpStr == $signature) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_post</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="comment">//检查消息是否来自微信</span></div><div class="line">     <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_from_wx()) &#123;</div><div class="line">         <span class="comment">//非法</span></div><div class="line">         <span class="keyword">echo</span> <span class="string">"非法操作"</span>;</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     <span class="comment">//获取POST参数</span></div><div class="line">     $param = file_get_contents(<span class="string">"php://input"</span>);</div><div class="line">     <span class="comment">//将xml格式中的数据读取成数组</span></div><div class="line">     $param = <span class="keyword">$this</span>-&gt;format-&gt;factory($param, <span class="string">'xml'</span>)-&gt;to_array();</div><div class="line"></div><div class="line">     <span class="comment">//将消息插入by_message表中</span></div><div class="line">     $result = <span class="keyword">$this</span>-&gt;share_model-&gt;insert($msg_info, <span class="string">'by_message'</span>);</div><div class="line">     </div><div class="line">     <span class="comment">//回复空字符串</span></div><div class="line">     <span class="keyword">echo</span> <span class="string">""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  上面代码值得注意有三个地方，第一个地方是我们检查消息是否来自微信，是获取<code>$_GET</code>中的参数；第二个地方是我们不能使用<code>$_POST</code>和<code>$this-&gt;post</code>来获取post参数，只能使用<code>file_get_contents(&quot;php://input&quot;)</code>来获取；第三个地方是当我们没有消息回复的时候，回复<code>success和空字符串</code>就代表交互成功，否则用户就会看到<code>该公众号暂时无法提供服务</code>。</p>
<p>  当写好代码之后，我们在微信公众号中发送消息，它就会将消息存入到<code>by_message</code>表中，我们就可以进行查看。如果出现<code>该公众号暂时无法提供服务</code>，那就可能我们服务器出错误了，可以开启日志功能，使用<code>log_message</code>输出日志进行调试。</p>
<p> 当接收消息没问题之后，我们就可以进行回复消息了，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_post</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//检查消息是否来自微信</span></div><div class="line">    <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_from_wx()) &#123;</div><div class="line">        <span class="comment">//非法</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">"非法操作"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//获取POST参数</span></div><div class="line">    $param = file_get_contents(<span class="string">"php://input"</span>);</div><div class="line">    <span class="comment">//获取xml中的数据</span></div><div class="line">    $param = <span class="keyword">$this</span>-&gt;format-&gt;factory($param, <span class="string">'xml'</span>)-&gt;to_array();</div><div class="line"></div><div class="line">    <span class="comment">//选出参数</span></div><div class="line">    $msg_info = array_choose($param, [<span class="string">'Content'</span>, <span class="string">'ToUserName'</span>, <span class="string">'FromUserName'</span>, <span class="string">'MsgId'</span>, <span class="string">'MsgType'</span>]);</div><div class="line">    <span class="comment">//将消息插入数据库</span></div><div class="line">    $result = <span class="keyword">$this</span>-&gt;share_model-&gt;insert($msg_info, <span class="string">'by_message'</span>);</div><div class="line"></div><div class="line">    <span class="comment">//获取信息</span></div><div class="line">    $to_user = $param[<span class="string">'ToUserName'</span>];</div><div class="line">    $from_user = $param[<span class="string">'FromUserName'</span>];</div><div class="line">    $content = $param[<span class="string">'Content'</span>];</div><div class="line"></div><div class="line">    <span class="comment">//去掉消息id</span></div><div class="line">    <span class="keyword">unset</span>($param[<span class="string">'MsgId'</span>]);</div><div class="line"></div><div class="line">    <span class="comment">//回复的内容</span></div><div class="line">    $content = <span class="string">'http://xxxxxx.com/'</span>;</div><div class="line">    $response_text = <span class="string">"&lt;xml&gt;</span></div><div class="line"><span class="string">                        &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;</span></div><div class="line"><span class="string">                        &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;</span></div><div class="line"><span class="string">                        &lt;CreateTime&gt;%s&lt;/CreateTime&gt;</span></div><div class="line"><span class="string">                        &lt;MsgType&gt;&lt;![CDATA[%s]]&gt;&lt;/MsgType&gt;</span></div><div class="line"><span class="string">                        &lt;Content&gt;&lt;![CDATA[%s]]&gt;&lt;/Content&gt;</span></div><div class="line"><span class="string">                      &lt;/xml&gt;"</span>;</div><div class="line">    $response_text = sprintf($response_text, $from_user, $to_user, time(), $param[<span class="string">'MsgType'</span>], $content);</div><div class="line">    <span class="keyword">echo</span> $response_text;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置好之后，我们在微信公众输入字符，它就会回复<code>http://xxxxxx.com/</code>。</p>
<p>上面代码需要注意的是，我们回复消息的时候，返回的数据格式是<code>xml格式</code>的，而且对格式有严格要求。我前面使用框架中的<code>format类</code>生成xml的数据是无法被微信读取的，所以建议和我上面一样的写法。</p>
<p>还有，上面回复的消息是文本消息，我们还可以回复图片、图文、语音、视频、音乐等消息，其实它们都大体相同，查看官方的文档<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140543&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">被动回复用户消息</a>这一节，按照对应的格式进行回复就行了。</p>
<p>到这一步的时候，是不是很有成就感？其实，这还是很小的一步，微信开发还有很多的内容，就消息管理这部分来说，它就分接收和发送消息两大类。    </p>
<p>其中，接收消息有两种：        </p>
<ul>
<li>第一种：接收普通消息，它是微信用户向公众号发送的消息，我们上面说的就是接收普通消息。</li>
<li>第二种：接收事件消息，它是微信用户在微信公众号里面交互过程中产生的事件消息，例如关注/取消事件、扫描带参数二维码等等。具体可以接收哪些事件消息，就去查询微信的开发文档吧。接收事件消息说起来很高端的样子，其实它和普通消息差不多，整个接收和回复流程和上面一样，只是有的事件消息是不允许我们回复用户的。</li>
</ul>
<p>而发送消息就有被动<code>回复消息</code>、<code>客服消息</code>、<code>群发消息</code>、<code>模板消息</code>四种，其中这四种我又把它分成两小类，被动回复消息算是一类，我们前面实现对用户消息的回复就算是这一类；另外三种我将它们归类为主动发送消息，与被动回复消息不同的是，它会被微信主动推送给用户，流程大概如下图：</p>
<p><img src="http://ww1.sinaimg.cn/large/7746cd07jw1f66jvxhdfij20nx07uaaf.jpg" alt=""></p>
<p>了解了流程之后，我们下面来实现模板消息的发送。</p>
<h2 id="三、发送模板消息"><a href="#三、发送模板消息" class="headerlink" title="三、发送模板消息"></a>三、发送模板消息</h2><p>模板消息可以定制，而且发送模板消息后，微信会主动推送给用户，这是我们开发很需要的一个功能。（注：模板消息只有认证后的服务号才可以使用）。</p>
<p>首先，我们在微信公众平台的<code>功能-&gt;添加功能插件</code>处添加这个功能，进入模板消息页面，从模板库中添加一个模板消息，获取到模板ID。当然，我们也可以创建一个符号自己业务的模板消息，进行定制（这个需要申请）。</p>
<p>然后，我们对应着模板详情的数据格式，写一个接口专门用来发送模板消息。</p>
<p>下面是模板详情：</p>
<p><img src="http://ww2.sinaimg.cn/large/7746cd07jw1f658hkxak6j20iu0kb75u.jpg" alt=""></p>
<p>对应上面的模板消息，我们的接口这么写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 发送模板消息</div><div class="line">     */</div><div class="line">    public function send_template_message_get() &#123;</div><div class="line">        //检查参数</div><div class="line">        param_check($this-&gt;get(), [&apos;uid&apos;]);</div><div class="line">        $uid = $this-&gt;get(&apos;uid&apos;);</div><div class="line"></div><div class="line">        //wx appid</div><div class="line">        $wx_app_id = WX_APP_ID;</div><div class="line">        $wx_app_secret = WX_APP_SECRET;</div><div class="line"></div><div class="line">        //get access token</div><div class="line">        $token_info = file_get_contents(&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=$wx_app_id&amp;secret=$wx_app_secret&quot;);</div><div class="line">        $token_info = json_decode($token_info, true);</div><div class="line">        $access_token = $token_info[&apos;access_token&apos;];</div><div class="line"></div><div class="line">        //获取用户信息</div><div class="line">        $openid = $this-&gt;user_model-&gt;get_value(&apos;openid&apos;, $uid);</div><div class="line"></div><div class="line">        //组织参数</div><div class="line">        $param = array(</div><div class="line">            &quot;touser&quot; =&gt; $openid,</div><div class="line">            &quot;template_id&quot; =&gt; &quot;jt_Rl5X9QWXMiRihrQz67n4riGt3kaPA81Zku0wLm9M&quot;,</div><div class="line">            &quot;url&quot; =&gt; &quot;http://www.beyondwinlaw.com/test/wx/test/home.html&quot;,</div><div class="line">            &quot;data&quot; =&gt; [</div><div class="line">                &quot;first&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;案件有新进展&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;keyword1&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;jkfdjafjdsfjdjfs&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;keyword2&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;jkfdjafjdsfjdjfs&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;keyword3&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;jkfdjafjdsfjdjfs&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;keyword4&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;2016-07-12 11:11:11&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;keyword5&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;jkfdjafjdsfjdjfs&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ],</div><div class="line">                &quot;remark&quot; =&gt; [</div><div class="line">                    &quot;value&quot; =&gt; &quot;点击查看案件进度详情&quot;,</div><div class="line">                    &quot;color&quot; =&gt; &quot;#173177&quot;</div><div class="line">                ]</div><div class="line">            ]</div><div class="line">        );</div><div class="line"></div><div class="line">        //发送请求</div><div class="line">        $url = &quot;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=$access_token&quot;;</div><div class="line">        $result = send_post($url, $param);</div><div class="line">        answer([</div><div class="line">            &quot;result&quot; =&gt; $result</div><div class="line">        ]);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>效果是这样的：</p>
<p align="center"><br>  <img src="http://ww3.sinaimg.cn/mw690/7746cd07jw1f65905jwfbj20mq10iq75.jpg" height="554" width="345"><br></p>

<p>这样，我们就实现了模板消息的发送，至于客服消息、群发接口，原理差不多，因为我没实现过，这里就不多说了。</p>
<h2 id="四、网页授权，获取用户信息"><a href="#四、网页授权，获取用户信息" class="headerlink" title="四、网页授权，获取用户信息"></a>四、网页授权，获取用户信息</h2><p>微信采用的是OAuth对开发者进行授权的，具体OAuth授权原理请google查询。在开发之前，我们需要先到公众平台官网中的<code>开发-接口权限-网页服务-网页授权获取用户基本信息</code>的配置选项中，修改授权回调域名。</p>
<p><img src="http://ww2.sinaimg.cn/large/7746cd07jw1f65ggry50ij20y20dimyr.jpg" alt=""></p>
<p>整个授权过程，其实微信官方已经说的很清楚了。我这里简略说一下，算是总结下吧！</p>
<p>首先，我们需要获取access_token，它的时序图和微信开放平台类似，如下：<br><img src="http://ww1.sinaimg.cn/mw690/7746cd07jw1f68rcxtd2lj21020fu40c.jpg" alt=""></p>
<p>这整个过程是当用户要登录我们的网站时，我们带上回调地址、AppId、scope等参数跳转到微信授权页面；然后获得用户的同意之后，它会跳转到我们的回调地址，并带上code参数；最后我们通过code、AppId、AppSecret请求接口，获取access_token。</p>
<p>之后，我们通过access_token请求对应的接口，就可以获取用户的基本信息了。</p>
<p>需要注意地方有两个：</p>
<ol>
<li>我们的回调地址需要进行encodeURL，否则可能回调地址中url后面的参数会丢失。</li>
<li>我们的回调地址的域名必须是前面配置的域名。</li>
</ol>
<p>具体的实现细节，根据官方文档<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140842&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">微信网页授权</a>和<a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419316505&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">网站应用微信登录开发指南</a>的步骤来就行了。</p>
<h2 id="五、JS-SDK的使用"><a href="#五、JS-SDK的使用" class="headerlink" title="五、JS-SDK的使用"></a>五、JS-SDK的使用</h2><p>在我们要做的产品中，我们希望能够控制每个页面分享的链接，而JS-SDK就可以做到这一切。<br>它的使用步骤可以查阅<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">微信JS-SDK说明文档</a>这个文档，而且在网页最后还有对应的<a href="http://demo.open.weixin.qq.com/jssdk" target="_blank" rel="external">DEMO页面</a>和<a href="http://demo.open.weixin.qq.com/jssdk/sample.zip" target="_blank" rel="external">示例代码</a>。</p>
<p>我们的实现是这样的，在前端专门写了一个JS文件<code>wx_share.js</code>，这个JS文件中将当前的url传给后台，请求后台的数据对JS-SDK进行配置。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> server_url = <span class="string">"http://192.168.30.249/by/wx_api/index.php/share/wx_config"</span>;</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">window</span>.location.href;</div><div class="line"></div><div class="line"><span class="comment">//配置微信</span></div><div class="line">$.ajax(&#123;</div><div class="line">    type: <span class="string">"GET"</span>,</div><div class="line">    url: server_url,</div><div class="line">    data: &#123;</div><div class="line">        url: <span class="built_in">encodeURI</span>(url)</div><div class="line">    &#125;,</div><div class="line">    dataType: <span class="string">"json"</span>,</div><div class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">        <span class="comment">// alert('请求分享配置数据成功');</span></div><div class="line">        wx.config(&#123;</div><div class="line">            debug: <span class="literal">false</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></div><div class="line">            appId: data.data.appId, <span class="comment">// 必填，公众号的唯一标识</span></div><div class="line">            timestamp: data.data.timestamp, <span class="comment">// 必填，生成签名的时间戳</span></div><div class="line">            nonceStr: data.data.nonceStr, <span class="comment">// 必填，生成签名的随机串</span></div><div class="line">            signature: data.data.signature,<span class="comment">// 必填，签名，见附录1</span></div><div class="line">            jsApiList: [<span class="string">'onMenuShareAppMessage'</span>, <span class="string">'onMenuShareTimeline'</span>] <span class="comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span></div><div class="line">        &#125;);</div><div class="line">        wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// alert("分享验证完毕");</span></div><div class="line">        &#125;);</div><div class="line">        wx.error(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// alert("分享验证失败");</span></div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//获取uid和link_id</span></div><div class="line">        <span class="keyword">var</span> uid = localStorage.getItem(<span class="string">"uid"</span>);</div><div class="line">        <span class="keyword">var</span> linkId = localStorage.getItem(<span class="string">"link_id"</span>);</div><div class="line">        <span class="keyword">var</span> shareUrl = <span class="string">"http://www.baidu.com"</span>;</div><div class="line">        <span class="comment">//存在linkId, 则分享带上link_id等参数</span></div><div class="line">        <span class="keyword">if</span>(linkId != <span class="literal">undefined</span> &amp;&amp; linkId != <span class="string">""</span> &amp;&amp; linkId != <span class="literal">null</span>) &#123;</div><div class="line">          shareUrl = shareUrl + <span class="string">"?super_id="</span> + uid + <span class="string">"&amp;link_id="</span> + linkId;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// alert("分享链接: "+shareUrl);</span></div><div class="line"></div><div class="line">        wx.onMenuShareAppMessage(&#123;</div><div class="line">            title: <span class="string">'分享测试'</span>, <span class="comment">// 分享标题</span></div><div class="line">            desc: <span class="string">'测试一下'</span>, <span class="comment">// 分享描述</span></div><div class="line">            link: shareUrl, <span class="comment">// 分享链接</span></div><div class="line">            imgUrl: <span class="string">'http://www.beyondwinlaw.com/gw4/images/zhongjie.jpg'</span>, <span class="comment">// 分享图标</span></div><div class="line">            type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></div><div class="line">            dataUrl: <span class="string">''</span>, <span class="comment">// 如果type是music或video，则要提供数据链接，默认为空</span></div><div class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="comment">// 用户确认分享后执行的回调函数</span></div><div class="line">                <span class="comment">// alert("分享成功");</span></div><div class="line">            &#125;,</div><div class="line">            cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="comment">// 用户取消分享后执行的回调函数</span></div><div class="line">                <span class="comment">// alert("取消分享");</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    error: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">        alert(<span class="string">'请求分享配置数据失败'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>而具体JS-SDK权限签名算法的实现是放在后台的，这个实现我是直接使用官方的<code>jssdk</code>的类，只是将它稍微修改了下。<br><code>share.php</code>中<code>wx_config</code>接口实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 获取微信配置</div><div class="line"> */</div><div class="line">public function wx_config_get() &#123;</div><div class="line">    //获取参数</div><div class="line">    param_check($this-&gt;get(), [&apos;url&apos;]);</div><div class="line">    $url = $this-&gt;get(&apos;url&apos;);</div><div class="line">    $url = urldecode($url);</div><div class="line"></div><div class="line">    $jssdk = new JSSDK(WX_APP_ID, WX_APP_SECRET, $url);</div><div class="line">    $signPackage = $jssdk-&gt;GetSignPackage();</div><div class="line">    answer($signPackage);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而修改后的JS-SDK代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">class JSSDK &#123;</div><div class="line">  private $appId;</div><div class="line">  private $appSecret;</div><div class="line">  private $url;</div><div class="line"></div><div class="line">  public function __construct($appId, $appSecret, $url) &#123;</div><div class="line">    $this-&gt;appId = $appId;</div><div class="line">    $this-&gt;appSecret = $appSecret;</div><div class="line">    $this-&gt;url = $url;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public function getSignPackage() &#123;</div><div class="line">    // 注意 URL 一定要动态获取，不能 hardcode.</div><div class="line">//    $protocol = (!empty($_SERVER[&apos;HTTPS&apos;]) &amp;&amp; $_SERVER[&apos;HTTPS&apos;] !== &apos;off&apos; || $_SERVER[&apos;SERVER_PORT&apos;] == 443) ? &quot;https://&quot; : &quot;http://&quot;;</div><div class="line">//    $url = &quot;$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]&quot;;</div><div class="line">    $url = $this-&gt;url;</div><div class="line"></div><div class="line">    //wx appid</div><div class="line">    $wx_app_id = $this-&gt;appId;</div><div class="line">    $wx_app_secret = $this-&gt;appSecret;</div><div class="line"></div><div class="line">    //get token</div><div class="line">    $token_info = file_get_contents(&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=$wx_app_id&amp;secret=$wx_app_secret&quot;);</div><div class="line">    $token_info = json_decode($token_info, true);</div><div class="line">    $access_token = $token_info[&apos;access_token&apos;];</div><div class="line"></div><div class="line">    //get ticket</div><div class="line">    $ticket_info = file_get_contents(&quot;https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=$access_token&amp;type=jsapi&quot;);</div><div class="line">    $ticket_info = json_decode($ticket_info, true);</div><div class="line">    $ticket = $ticket_info[&apos;ticket&apos;];</div><div class="line">    </div><div class="line">    //拼接字符串</div><div class="line">    $timestamp = time();</div><div class="line">    $nonceStr = $this-&gt;createNonceStr();</div><div class="line">    // 这里参数的顺序要按照 key 值 ASCII 码升序排序</div><div class="line">    $string = &quot;jsapi_ticket=$ticket&amp;noncestr=$nonceStr&amp;timestamp=$timestamp&amp;url=$url&quot;;</div><div class="line"></div><div class="line">    //使用sha1进行签名</div><div class="line">    $signature = sha1($string);</div><div class="line"></div><div class="line">    $signPackage = array(</div><div class="line">      &quot;appId&quot;     =&gt; $this-&gt;appId,</div><div class="line">      &quot;nonceStr&quot;  =&gt; $nonceStr,</div><div class="line">      &quot;timestamp&quot; =&gt; $timestamp,</div><div class="line">      &quot;url&quot;       =&gt; $url,</div><div class="line">      &quot;signature&quot; =&gt; $signature,</div><div class="line">      &quot;rawString&quot; =&gt; $string</div><div class="line">    );</div><div class="line">    return $signPackage; </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private function createNonceStr($length = 16) &#123;</div><div class="line">    $chars = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;</div><div class="line">    $str = &quot;&quot;;</div><div class="line">    for ($i = 0; $i &lt; $length; $i++) &#123;</div><div class="line">      $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);</div><div class="line">    &#125;</div><div class="line">    return $str;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private function httpGet($url) &#123;</div><div class="line">    $curl = curl_init();</div><div class="line">    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);</div><div class="line">    curl_setopt($curl, CURLOPT_TIMEOUT, 500);</div><div class="line">    // 为保证第三方服务器与微信服务器之间数据传输的安全性，所有微信接口采用https方式调用，必须使用下面2行代码打开ssl安全校验。</div><div class="line">    // 如果在部署过程中代码在此处验证失败，请到 http://curl.haxx.se/ca/cacert.pem 下载新的证书判别文件。</div><div class="line">    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, true);</div><div class="line">    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, true);</div><div class="line">    curl_setopt($curl, CURLOPT_URL, $url);</div><div class="line"></div><div class="line">    $res = curl_exec($curl);</div><div class="line">    curl_close($curl);</div><div class="line"></div><div class="line">    return $res;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private function get_php_file($filename) &#123;</div><div class="line">    return trim(substr(file_get_contents($filename), 15));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要说明一下的是，这里我只是测试功能的实现，<code>获取access_token</code>是直接通过接口实时进行获取的。如果是在生产环境，还请参考官方的<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140183&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">获取access_token</a>。</p>
<p>在这里我碰到一个问题，耽搁了挺久的时间。那就是前面我按照官方文档自己写的签名算法，然后各种配置不成功。后来下载了官方的demo，发现官方文档jssdk没有问题，然后将自己的签名算法放入官方的jssdk中，也没有问题。因为官方文档是前后端放在一块的，所以总感觉url不对，但是对<code>url进行encodeURL</code>之后，发现还是不行。最后和小伙伴一起google了之后，<code>将生成数字随机替换成生成字母随机数</code>，然后配置就没问题了。</p>
<p>到这一步，逻辑已经全部实现，只需要在我们对应的页面中引入JS-SDK和wx_share.js文件就行了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;http://res.wx.qq.com/open/js/jweixin-1.1.0.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script src=&quot;js/wx_share.js&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>成功之后的效果如下：</p>
<p align="center"><br>  <img src="http://ww4.sinaimg.cn/large/7746cd07jw1f6e24s7grrj20ku112q4f.jpg" height="667" width="375"><br></p>

<h2 id="六、自定义菜单"><a href="#六、自定义菜单" class="headerlink" title="六、自定义菜单"></a>六、自定义菜单</h2><p>自定义菜单这个是比较简单的，我们只需要将我们配置数据POST到微信服务器，微信用户进入我们公众号之后，看到界面就变成了我们自定义菜单样式。<br>在这里，我也写了一个接口，用来修改菜单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * 更改微信公众号菜单</span></div><div class="line"><span class="comment">  * <span class="doctag">@note</span> 这个接口在线上是禁止调用的,它只需要更改的时候,调用一次就行了</span></div><div class="line"><span class="comment">  */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">change_menu_get</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="comment">//获取access_token, 需要中控服务器,否则会造成服务不稳定,咱们这里暂时不这么做</span></div><div class="line">     $app_id = WX_APP_ID;</div><div class="line">     $app_secret = WX_APP_SECRET;</div><div class="line">     $content = file_get_contents(<span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=$app_id&amp;secret=$app_secret"</span>);</div><div class="line">     $info = json_decode($content, <span class="keyword">true</span>);</div><div class="line">     $access_token = $info[<span class="string">'access_token'</span>];</div><div class="line"></div><div class="line">     <span class="comment">//自定义菜单</span></div><div class="line">     $auth_url = <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid=&#123;$app_id&#125;&amp;redirect_uri=http://www.liuchungui.com/api/wx_api/index.php/share/test&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=123#wechat_redirect"</span>;</div><div class="line"></div><div class="line">     $menu = <span class="keyword">array</span>(</div><div class="line">         <span class="string">"button"</span> =&gt; [</div><div class="line">             [</div><div class="line">                 <span class="string">"type"</span> =&gt; <span class="string">"view"</span>,</div><div class="line">                 <span class="string">"name"</span> =&gt; <span class="string">"合作"</span>,</div><div class="line">                 <span class="string">"url"</span> =&gt; $auth_url</div><div class="line">             ],</div><div class="line">             [</div><div class="line">                 <span class="string">"name"</span> =&gt; <span class="string">"菜单"</span>,</div><div class="line">                 <span class="string">"sub_button"</span> =&gt; [</div><div class="line">                     [</div><div class="line">                         <span class="string">"type"</span> =&gt; <span class="string">"view"</span>,</div><div class="line">                         <span class="string">"name"</span> =&gt; <span class="string">"官网"</span>,</div><div class="line">                         <span class="string">"url"</span> =&gt; <span class="string">"http://www.liuchungui.com/"</span></div><div class="line">                     ],</div><div class="line">                     [</div><div class="line">                         <span class="string">"type"</span> =&gt; <span class="string">"view"</span>,</div><div class="line">                         <span class="string">"name"</span> =&gt; <span class="string">"关于我们"</span>,</div><div class="line">                         <span class="string">"url"</span> =&gt; <span class="string">"http://www.liuchungui.com/about.html"</span></div><div class="line">                     ]</div><div class="line">                 ]</div><div class="line">             ]</div><div class="line">         ]</div><div class="line">     );</div><div class="line"></div><div class="line">     $menu_url = <span class="string">"https://api.weixin.qq.com/cgi-bin/menu/create?access_token=$access_token"</span>;</div><div class="line">     <span class="comment">//发送POST请求</span></div><div class="line">     $result = send_post($menu_url, $menu);</div><div class="line">     $result = json_decode($result, <span class="keyword">true</span>);</div><div class="line">     <span class="comment">//返回数据</span></div><div class="line">     <span class="keyword">if</span>($result[<span class="string">'errcode'</span>] === <span class="number">0</span>) &#123;</div><div class="line">         answer(<span class="keyword">true</span>, <span class="string">'更改菜单'</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">else</span> &#123;</div><div class="line">         answer(<span class="keyword">false</span>, <span class="string">'更改菜单'</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>这个只是创建菜单，其他操作菜单的接口请查阅<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141013&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">自定义菜单</a>。</p>
<p>效果如下：</p>
<p align="center"><br>  <img src="http://ww2.sinaimg.cn/mw690/7746cd07jw1f67s9b3h6hj20ks10c78z.jpg" height="604" width="345"><br></p>

<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><p>在搜索资料的时候，无意之间找到一个微信公众号开发的框架<a href="https://github.com/overtrue/wechat" target="_blank" rel="external">wechat</a>，star不少，而且看了下开发文档<a href="https://easywechat.org/" target="_blank" rel="external">EasyWechat</a>，讲得比较详细，应该是一个不错的框架，后期准备使用它来进行开发，推荐大家看看。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.liuchungui.com/2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" data-id="cj7fit18s001lsofy0ima3fvp" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/08/09/搭建Hexo博客/" class="pre">搭建Hexo博客</a><a href="/2016/05/10/mac10-dot-11sheng-ji-an-zhuang-openssl/" class="next">Mac10.11升级安装openssl</a></div><div data-thread-key="2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" data-title="微信公众号开发总结" data-url="http://www.liuchungui.com/2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" data-title="微信公众号开发总结" data-url="http://www.liuchungui.com/2016/08/01/wei-xin-gong-zhong-hao-kai-fa-zong-jie/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.liuchungui.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gitbook/">Gitbook</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/angular/">angular</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/octopress/">octopress</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/年度总结/">年度总结</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/Numpy与Pandas使用/">Numpy与Pandas使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/10/Linux安装和部署Redis/">Linux下安装和部署Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/word2vec初体验/">word2vec初体验</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/Jupyter-notebook安装使用/">Jupyter notebook安装使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/Anaconda安装使用/">Anaconda安装使用笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/02/2016年的个人总结/">2016年的个人总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/webpack开发和生产环境的建立/">webpack开发和生产环境的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/05/Angular中使用webpack基础篇/">Angular中使用webpack基础篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/Angular-CI跨域请求/">CI+Angular之CORS跨域请求实践篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/22/bootstrap-datetimepicker集成到angular使用/">angular中使用时间控件bootstrap-datetimepicker</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">刘春桂的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'liuchungui'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?40391c9d11f57c2384e5811d517bef62";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>