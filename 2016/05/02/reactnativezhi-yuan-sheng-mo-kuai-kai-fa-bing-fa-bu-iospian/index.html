<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ReactNative之原生模块开发并发布——iOS篇 | 刘春桂的博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ReactNative之原生模块开发并发布——iOS篇</h1><a id="logo" href="/.">刘春桂的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ReactNative之原生模块开发并发布——iOS篇</h1><div class="post-meta">May 2, 2016<span> | </span><span class="category"><a href="/categories/ReactNative/">ReactNative</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" href="/2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/#comments" class="ds-thread-count"></a><div class="post-content"><p>前段时间做了个ReactNative的App，发现ReactNative中不少组件并不存在，所以还是需要自己对原生模块进行编写让JS调用，正是因为在这个编写过程中遇到不少问题，发觉了官网文档中许多的不足。所以产生了写一个实践教程的想法，最终有了这么一篇文章。</p>
<p>整篇文章主要以编写一个原生模块为例子，来讲述了我们在编写原生模块所用到的一些知识，并且在整个例子中，配有了完整的实践代码，方便大家理解并调试。除了这些内容，文章还讲述了我们如何将自己编写的原生模块发布到npm上分享给别人使用。希望能够给大家带来帮助，也希望大家将自己编写的原生模块分享出来。</p>
<p>示例代码github地址：<a href="https://github.com/liuchungui/react-native-BGNativeModuleExample" target="_blank" rel="external">https://github.com/liuchungui/react-native-BGNativeModuleExample</a></p>
<p>编写android原生模块，请看<a href="http://www.liuchungui.com/blog/2016/05/08/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-androidpian/">ReactNative之原生模块开发并发布——android篇</a></p>
<a id="more"></a>
<h2 id="准备工作："><a href="#准备工作：" class="headerlink" title="准备工作："></a>准备工作：</h2><h4 id="创建ReactNative工程"><a href="#创建ReactNative工程" class="headerlink" title="创建ReactNative工程"></a>创建ReactNative工程</h4><p>我们需要先创建一个ReactNative工程，使用如下命令创建。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react native init TestProject</div></pre></td></tr></table></figure>
<p>创建好工程之后，我们使用xcode打开<code>TestProject/ios/</code>下的iOS工程。</p>
<h4 id="创建静态库，并将这个静态库手动链接到工程中"><a href="#创建静态库，并将这个静态库手动链接到工程中" class="headerlink" title="创建静态库，并将这个静态库手动链接到工程中"></a>创建静态库，并将这个静态库手动链接到工程中</h4><p>首先，我们在前面创建的ReactNative工程下的<code>node_modules</code>创建一个文件夹<code>react-native-BGNativeModuleExample</code>，然后我们在新创建的文件夹下再创建一个ios文件夹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cd TestProject/node_modules</div><div class="line">$ mkdir react-native-BGNativeModuleExample</div><div class="line">$ cd react-native-BGNativeModuleExample</div><div class="line">$ mkdir ios</div></pre></td></tr></table></figure>
<p>然后，由于ReactNative的组件都是一个个静态库，我们发布到npm给别人使用的话，也需要建立静态库。我们使用xcode建立静态库，取名为<code>BGNativeModuleExample</code>。建立之后，我们将创建的静态库中的文件全部copy到<code>node_modules/react-native-BGNativeModuleExample/ios</code>目录下。<br>ios文件目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">|____BGNativeModuleExample</div><div class="line">| |____BGNativeModuleExample.h</div><div class="line">| |____BGNativeModuleExample.m</div><div class="line">|____BGNativeModuleExample.xcodeproj</div></pre></td></tr></table></figure>
<p>最后，我们需要手动将这个静态库链接到工程中。</p>
<p>1、使用xcode打开创建的静态库，添加一行<code>Header Search Paths</code>，值为<code>$(SRCROOT)/../../react-native/React</code>，并设置为<code>recursive</code>。</p>
<p><img src="http://ww2.sinaimg.cn/large/7746cd07jw1f3h69rwj3oj212s0r7dm6.jpg" alt=""></p>
<p>2、将<code>BGNativeModuleExample</code>静态库工程拖动到工程中的Library中。<br><img src="http://ww1.sinaimg.cn/large/7746cd07jw1f3o30vl8wjj20xq0fawi3.jpg" alt=""></p>
<p>3、选中 TARGETS =&gt; TestProject =&gt; Build Settings =&gt; Link Binary With Libraries，添加<code>libBGNativeModuleExample.a</code>这个静态库<br><img src="http://ww3.sinaimg.cn/large/7746cd07jw1f3o2v5wrgyj212r0hgq72.jpg" alt=""></p>
<p>到此，我们准备工作完成了。我们这里这么准备是有用意的，那就是模拟npm链接的过程，建立好了环境，避免了发布到npm上后别人使用找不到静态库的问题。</p>
<h2 id="一、编写原生模块代码"><a href="#一、编写原生模块代码" class="headerlink" title="一、编写原生模块代码"></a>一、编写原生模块代码</h2><h4 id="1、创建原生模块"><a href="#1、创建原生模块" class="headerlink" title="1、创建原生模块"></a>1、创建原生模块</h4><p>选中我们创建的<code>BGNativeModuleExample</code>静态库，然后在<code>BGNativeModuleExample.h</code>文件中导入<code>RCTBridgeModule.h</code>，让<code>BGNativeModuleExample</code>类遵循<code>RCTBridgeModule</code>协议。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BGNativeModuleExample.h文件的内容如下</span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"RCTBridgeModule.h"</span></span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BGNativeModuleExample</span> : <span class="title">NSObject</span> &lt;<span class="title">RCTBridgeModule</span>&gt;</span></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>在<code>BGNativeModuleExample.m</code>文件中，我们需要实现<code>RCTBridgeModule</code>协议。为了实现<code>RCTBridgeModule</code>协议，我们的类需要包含RCT_EXPORT_MODULE()宏。这个宏也可以添加一个参数用来指定在Javascript中访问这个模块的名字。如果不指定，默认会使用这个类的名字。</p>
<p>在这里，我们指定了模块的名字为<code>BGNativeModuleExample</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RCT_EXPORT_MODULE(BGNativeModuleExample);</div></pre></td></tr></table></figure>
<p>实现了RCTBridgeModule协议之后，我们就可以在js中如下获取到我们创建的原生模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">import &#123; NativeModules &#125; from &apos;react-native&apos;;</div><div class="line">var BGNativeModuleExample = NativeModules.BGNativeModuleExample;</div></pre></td></tr></table></figure>
<p>需要注意的是，RCT_EXPORT_MODULE宏传递的参数不能是OC中的字符串。如果传递@”BGNativeModuleExample”，那么我们导出给JS的模块名字其实是@”BGNativeModuleExample”，使用BGNativeModuleExample就找不到了。在这里，我们其实可以通过打印<code>NativeModules</code>来查找到我们创建的原生模块。</p>
<h4 id="2、为原生模块添加方法"><a href="#2、为原生模块添加方法" class="headerlink" title="2、为原生模块添加方法"></a>2、为原生模块添加方法</h4><p>我们需要明确的声明要给JS导出的方法，否则ReactNative不会导出任何方法。声明通过RCT_EXPORT_METHOD()宏来实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RCT_EXPORT_METHOD(testPrint:(<span class="built_in">NSString</span> *)name info:(<span class="built_in">NSDictionary</span> *)info) &#123;</div><div class="line">  RCTLogInfo(<span class="string">@"%@: %@"</span>, name, info);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在JS中，我们可以这样调用这个方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BGNativeModuleExample.testPrint(<span class="string">"Jack"</span>, &#123;</div><div class="line">  height: <span class="string">'1.78m'</span>,</div><div class="line">  weight: <span class="string">'7kg'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="3、参数类型"><a href="#3、参数类型" class="headerlink" title="3、参数类型"></a>3、参数类型</h4><p>RCT_EXPORT_METHOD()支持所有标准的JSON类型，包括：</p>
<ul>
<li>string (NSString)</li>
<li>number (NSInteger, float, double, CGFloat, NSNumber)</li>
<li>boolean (BOOL, NSNumber)</li>
<li>array (NSArray) 包含本列表中任意类型</li>
<li>map (NSDictionary) 包含string类型的键和本列表中任意类型的值</li>
<li>function (RCTResponseSenderBlock)</li>
</ul>
<p>除此以外，任何RCTConvert类支持的的类型也都可以使用(参见<a href="https://github.com/facebook/react-native/blob/master/React/Base/RCTConvert.h" target="_blank" rel="external">RCTConvert</a>了解更多信息)。RCTConvert还提供了一系列辅助函数，用来接收一个JSON值并转换到原生Objective-C类型或类。</p>
<p>了解更多请点击<a href="http://reactnative.cn/docs/0.25/native-modules-ios.html#content" target="_blank" rel="external">原生模块</a></p>
<h4 id="4、回调函数"><a href="#4、回调函数" class="headerlink" title="4、回调函数"></a>4、回调函数</h4><blockquote>
<p>警告<br>本章节内容目前还处在实验阶段，因为我们还并没有太多的实践经验来处理回调函数。</p>
</blockquote>
<p>回调函数，在官方的文档中是有上面的一个警告，不过在使用过程暂时未发现问题。在OC中，我们添加一个<code>getNativeClass</code>方法，将当前模块的类名回调给JS。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RCT_EXPORT_METHOD(getNativeClass:(RCTResponseSenderBlock)callback) &#123;</div><div class="line">  callback(@[<span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在JS中，我们通过以下方式获取到原生模块的类名</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BGNativeModuleExample.getNativeClass(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"nativeClass: "</span>, name);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>原生模块通常只应调用回调函数一次。但是，它们可以保存callback并在将来调用。</strong>这在封装那些通过“委托函数”来获得返回值的iOS API时最常见。</p>
<h4 id="5、Promises"><a href="#5、Promises" class="headerlink" title="5、Promises"></a>5、Promises</h4><blockquote>
<p>原生模块还可以使用promise来简化代码，搭配ES2016(ES7)标准的async/await语法则效果更佳。如果桥接原生方法的最后两个参数是RCTPromiseResolveBlock和RCTPromiseRejectBlock，则对应的JS方法就会返回一个Promise对象。</p>
</blockquote>
<p>我们通过Promises来实现原生模块是否会响应方法，响应则返回YES，不响应则返回一个错误信息，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">RCT_REMAP_METHOD(testRespondMethod,</div><div class="line">                 name:(<span class="built_in">NSString</span> *)name</div><div class="line">                 resolver:(RCTPromiseResolveBlock)resolve</div><div class="line">                 rejecter:(RCTPromiseRejectBlock)reject) &#123;</div><div class="line">  <span class="keyword">if</span>([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(name)]) &#123;</div><div class="line">    resolve(@YES);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    reject(<span class="string">@"-1001"</span>, <span class="string">@"not respond this method"</span>, <span class="literal">nil</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在JS中，我们有两种方式调用，第一种是通过<code>then....catch</code>的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BGNativeModuleExample.testRespondMethod(<span class="string">"dealloc"</span>)</div><div class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"result is "</span>, result);</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(error);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>第二种是通过<code>try...catch</code>来调用，与第一种相比，第二种会报警告”Possible Unhandled Promiss Rejection (id:0)“。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  async testRespond() &#123;</div><div class="line">  try &#123;</div><div class="line">    var result = BGNativeModuleExample.testRespondMethod(&quot;hell&quot;);</div><div class="line">    if(result) &#123;</div><div class="line">      console.log(&quot;respond this method&quot;);</div><div class="line">    &#125;</div><div class="line">  &#125; catch (e) &#123;</div><div class="line">    console.log(e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意: 如果使用Promiss我们不需要参数，则在OC去掉name那一行就行了；如果需要多个参数，在name下面多加一行就行了，注意它们之间不需要添加逗号。</strong></p>
<h4 id="6、多线程"><a href="#6、多线程" class="headerlink" title="6、多线程"></a>6、多线程</h4><p>我们这里操作的模块没有涉及到UI，所以专门建立一个串行的队列给它使用，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return dispatch_queue_create(&quot;com.liuchungui.demo&quot;, DISPATCH_QUEUE_SERIAL);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意: 在模块之间共享分发队列<br>methodQueue方法会在模块被初始化的时候被执行一次，然后会被React Native的桥接机制保存下来，所以你不需要自己保存队列的引用，除非你希望在模块的其它地方使用它。但是，如果你希望在若干个模块中共享同一个队列，则需要自己保存并返回相同的队列实例；仅仅是返回相同名字的队列是不行的。</p>
</blockquote>
<p>更多线程的操作细节可以参考<a href="http://reactnative.cn/docs/0.24/native-modules-ios.html#content" target="_blank" rel="external">http://reactnative.cn/docs/0.24/native-modules-ios.html#content</a></p>
<h4 id="7、导出常量"><a href="#7、导出常量" class="headerlink" title="7、导出常量"></a>7、导出常量</h4><p>原生模块可以导出一些常量，这些常量在JavaScript端随时都可以访问。用这种方法来传递一些静态数据，可以避免通过bridge进行一次来回交互。</p>
<p>OC中，我们实现<code>constantsToExport</code>方法，如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSDictionary</span> *)constantsToExport &#123;</div><div class="line">  <span class="keyword">return</span> @&#123; <span class="string">@"BGModuleName"</span> : <span class="string">@"BGNativeModuleExample"</span>,</div><div class="line">            TestEventName: TestEventName</div><div class="line">            &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JS中，我们打印一下这个常量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log(<span class="string">"BGModuleName value is "</span>, BGNativeModuleExample.BGModuleName);</div></pre></td></tr></table></figure>
<p>但是注意这个常量仅仅在初始化的时候导出了一次，所以即使你在运行期间改变constantToExport返回的值，也不会影响到JavaScript环境下所得到的结果。</p>
<h4 id="8、给JS发送事件"><a href="#8、给JS发送事件" class="headerlink" title="8、给JS发送事件"></a>8、给JS发送事件</h4><p>即使没有被JS调用，本地模块也可以给JS发送事件通知。最直接的方式是使用<code>eventDispatcher</code>。</p>
<p>在这里，我们为了能够接收到事件，我们开一个定时器，每一秒发送一次事件。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"BGNativeModuleExample.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"RCTEventDispatcher.h"</span></span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">BGNativeModuleExample</span></span></div><div class="line"><span class="keyword">@synthesize</span> bridge = _bridge;</div><div class="line">- (<span class="keyword">instancetype</span>)init &#123;</div><div class="line">  <span class="keyword">if</span>(<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</div><div class="line">    [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(sendEventToJS) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)receiveNotification:(<span class="built_in">NSNotification</span> *)notification &#123;</div><div class="line">  [<span class="keyword">self</span>.bridge.eventDispatcher sendAppEventWithName:TestEventName body:@&#123;<span class="string">@"name"</span>: <span class="string">@"Jack"</span>&#125;];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>在JS中，我们这样接收事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NativeAppEventEmitter.addListener(BGNativeModuleExample.TestEventName, info =&gt; &#123;</div><div class="line">      console.log(info);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p><strong>注意： 编写OC代码时，需要添加<code>@synthesize bridge = _bridge;</code>，否则接收事件的时候就会报<code>Exception -[BGNativeModuleExample brige]; unrecognized selector sent to instance</code>的错误。</strong></p>
<p>上面原生代码就编写好了，主要以代码实践为主，弥补官方文档中的一些不足，如果要需要了解更多的原生模块封装的知识，可以参考<a href="http://reactnative.cn/docs/0.22/native-modules-ios.html#content" target="_blank" rel="external">原生模块</a>，也可以参考官方的源代码。</p>
<h2 id="二、发布上线"><a href="#二、发布上线" class="headerlink" title="二、发布上线"></a>二、发布上线</h2><p>我们按照上面步骤编写好原生模块之后，接下来将我们写的原生模块发布到npm。</p>
<h4 id="1、我们需要创建github仓库"><a href="#1、我们需要创建github仓库" class="headerlink" title="1、我们需要创建github仓库"></a>1、我们需要创建github仓库</h4><p>在github上创建一个仓库<code>react-native-BGNativeModuleExample</code>，然后关联到我们前面创建的<code>react-native-BGNativeModuleExample</code>目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cd TestProject/node_modules/react-native-BGNativeModuleExample</div><div class="line">$ git init .</div><div class="line">$ git remote add origin https://github.com/liuchungui/react-native-BGNativeModuleExample.git</div></pre></td></tr></table></figure>
<h4 id="2、我们需要创建原生模块的入口文件"><a href="#2、我们需要创建原生模块的入口文件" class="headerlink" title="2、我们需要创建原生模块的入口文件"></a>2、我们需要创建原生模块的入口文件</h4><p>我们需要在react-native-BGNativeModuleExample目录下创建一个index.js，它是整个原生模块的入口，我们这里只是将原生进行导出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//index.js</div><div class="line">import React, &#123; NativeModules &#125; from &apos;react-native&apos;;</div><div class="line">module.exports = NativeModules.BGNativeModuleExample;</div></pre></td></tr></table></figure>
<h4 id="3、发布到npm"><a href="#3、发布到npm" class="headerlink" title="3、发布到npm"></a>3、发布到npm</h4><p>在发布到npm之前，我们需要创建一个<code>package.json</code>文件，这个文件包含了module的所有信息，比如名称、版本、描述、依赖、作者、license等。<br>我们在react-native-BGNativeModuleExample根目录下使用<code>npm init</code>命令来创建<code>package.json</code>，系统会提示我们输入所需的信息，不想输入的直接按下<code>Enter</code>跳过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ npm init</div><div class="line">This utility will walk you through creating a package.json file.</div><div class="line">It only covers the most common items, and tries to guess sensible defaults.</div><div class="line"></div><div class="line">See `npm help json` for definitive documentation on these fields</div><div class="line">and exactly what they do.</div><div class="line"></div><div class="line">Use `npm install &lt;pkg&gt; --save` afterwards to install a package and</div><div class="line">save it as a dependency in the package.json file.</div><div class="line"></div><div class="line">Press ^C at any time to quit.</div><div class="line">name: (react-native-BGNativeModuleExample)</div></pre></td></tr></table></figure>
<p>输入完成之后，系统会要我们确认文件的内容是否有误，如果没有问题直接输入<code>yes</code>，那么<code>package.json</code>就创建好了。<br>我这里创建的package.json文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;react-native-nativemodule-example&quot;,</div><div class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</div><div class="line">  &quot;description&quot;: &quot;&quot;,</div><div class="line">  &quot;main&quot;: &quot;index.js&quot;,</div><div class="line">  &quot;scripts&quot;: &#123;</div><div class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;repository&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;git&quot;,</div><div class="line">    &quot;url&quot;: &quot;git+https://github.com/liuchungui/react-native-BGNativeModuleExample.git&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;author&quot;: &quot;&quot;,</div><div class="line">  &quot;license&quot;: &quot;ISC&quot;,</div><div class="line">  &quot;bugs&quot;: &#123;</div><div class="line">    &quot;url&quot;: &quot;https://github.com/liuchungui/react-native-BGNativeModuleExample/issues&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;homepage&quot;: &quot;https://github.com/liuchungui/react-native-BGNativeModuleExample#readme&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们编写的原生模块依赖于其他的原生模块，我们需要在<code>package.json</code>添加依赖关系，我们这里由于没有相关依赖，所以不需要添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;dependencies&quot;: &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>初始化完package.json，我们就可以发布到npm上面了。</strong></p>
<p>如果没有npm的账号，我们需要注册一个账号，这个账号会被添加到npm本地的配置中，用来发布module用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ npm adduser   </div><div class="line">Username: your name</div><div class="line">Password: your password</div><div class="line">Email: yourmail@gmail.com</div></pre></td></tr></table></figure>
<p>成功之后，npm会把认证信息存储在~/.npmrc中，并且可以通过以下命令查看npm当前使用的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm whoami</div></pre></td></tr></table></figure>
<p>以上完成之后，我们就可以进行发布了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$npm publish</div><div class="line">+ react-native-nativemodule-example@1.0.0</div></pre></td></tr></table></figure>
<p>到这里，我们已经成功把module发布到了<a href="npmjs.org">npmjs.org</a>。当然，我们也别忘记将我们的代码发布到github。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git pull origin master</div><div class="line">$ git add .</div><div class="line">$ git commit -m &apos;add Project&apos;</div><div class="line">$ git push origin master</div></pre></td></tr></table></figure>
<p>有时候，有些文件没必要发布，例如Example文件，我们就可以通过<code>.npmignore</code>忽略它。例如我这里<code>.npmignore</code>文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Example/</div><div class="line">.git</div><div class="line">.gitignore</div><div class="line">.idea</div></pre></td></tr></table></figure>
<p>这样的话，我们npm进行发布的时候，就不会将Example发布到npm上了。</p>
<h4 id="4、添加Example，测试是否可用，添加README"><a href="#4、添加Example，测试是否可用，添加README" class="headerlink" title="4、添加Example，测试是否可用，添加README"></a>4、添加Example，测试是否可用，添加README</h4><p>我们在<code>react-native-BGNativeModuleExample</code>目录下创建一个Example的ReactNative工程，并且通过<code>rnpm install react-native-nativemodule-example</code>命令安装我们发布的<code>react-native-nativemodule-example</code>模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ rnpm install react-native-nativemodule-example</div><div class="line">TestProject@0.0.1 /Users/user/github/TestProject</div><div class="line">└── react-native-nativemodule-example@1.0.0 </div><div class="line"></div><div class="line">rnpm-link info Linking react-native-nativemodule-example ios dependency </div><div class="line">rnpm-link info iOS module react-native-nativemodule-example has been successfully linked </div><div class="line">rnpm-link info Module react-native-nativemodule-example has been successfully installed &amp; linked</div></pre></td></tr></table></figure>
<p>上面提示安装并且link成功，我们就可以在js中进行使用了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">import BGNativeModuleExample from &apos;react-native-nativemodule-example&apos;;</div><div class="line"></div><div class="line">BGNativeModuleExample.testPrint(&quot;Jack&quot;, &#123;</div><div class="line">    height: &apos;1.78m&apos;,</div><div class="line">    weight: &apos;7kg&apos;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="5、我们在发布上线之后还需要编写README文件。"><a href="#5、我们在发布上线之后还需要编写README文件。" class="headerlink" title="5、我们在发布上线之后还需要编写README文件。"></a>5、我们在发布上线之后还需要编写README文件。</h4><p>README文件是非常重要的，如果没有README文件，别人看到我们的原生组件，根本就不知道我们这个组件是用来干啥的。所以，我们很有必要添加一个README文件，这个文件需要告诉别人我们这个原生组件是干什么的、如何安装、API、使用手册等等。</p>
<h4 id="6、原生模块升级，发布新版本"><a href="#6、原生模块升级，发布新版本" class="headerlink" title="6、原生模块升级，发布新版本"></a>6、原生模块升级，发布新版本</h4><p>当我们添加新代码或者修复bug后，需要发布新的版本，我们只需要修改package.json文件中的<code>version</code>的值就行了，然后使用<code>npm publish</code>进行发布。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇文章主要分成两个部分，一是讲述了编写原生模块的知识，二是将我们编写的内容发布到npm上。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://weizhifeng.net/how-to-publish-a-node-module.html" target="_blank" rel="external">如何发布Node模块到NPM社区</a></p>
<p><a href="http://reactnative.cn/docs/0.22/native-modules-ios.html#content" target="_blank" rel="external">原生模块</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.liuchungui.com/2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" data-id="cj773u222001br7fyvevjyhlv" class="article-share-link">分享到</a><div class="tags"><a href="/tags/ReactNative-原生模块-react-native-ReactNative原生模块-react-native-原生模块-react-native-原生模块发布-reactNative原生模块ios/">ReactNative, 原生模块, react native, ReactNative原生模块, react native 原生模块, react native 原生模块发布,reactNative原生模块ios</a></div><div class="post-nav"><a href="/2016/05/08/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-androidpian/" class="pre">ReactNative之原生模块开发并发布——android篇</a><a href="/2016/04/23/ubuntuxia-da-jian-vpn/" class="next">ubuntu下搭建vpn历程</a></div><div data-thread-key="2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" data-title="ReactNative之原生模块开发并发布——iOS篇" data-url="http://www.liuchungui.com/2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" data-title="ReactNative之原生模块开发并发布——iOS篇" data-url="http://www.liuchungui.com/2016/05/02/reactnativezhi-yuan-sheng-mo-kuai-kai-fa-bing-fa-bu-iospian/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.liuchungui.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gitbook/">Gitbook</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/angular/">angular</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/octopress/">octopress</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/年度总结/">年度总结</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/word2vec初体验/">word2vec初体验</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/Jupyter-notebook安装使用/">Jupyter notebook安装使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/Anaconda安装使用/">Anaconda安装使用笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/02/2016年的个人总结/">2016年的个人总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/webpack开发和生产环境的建立/">webpack开发和生产环境的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/05/Angular中使用webpack基础篇/">Angular中使用webpack基础篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/Angular-CI跨域请求/">CI+Angular之CORS跨域请求实践篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/22/bootstrap-datetimepicker集成到angular使用/">angular中使用时间控件bootstrap-datetimepicker</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/03/angular-入门之常用指令使用/">Angular1.5 入门之常用指令使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/搭建Hexo博客/">搭建Hexo博客</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">刘春桂的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'liuchungui'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?40391c9d11f57c2384e5811d517bef62";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>